---
title: "CSN - Second Lab"
author: "Kymry Burwell, Laura Cebollero"
geometry: "left=3cm,right=3cm,top=2cm,bottom=2cm"
date: "October 7th, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
requiredPackages <- c("igraph", "ggplot2", "data.table", "expss", "stats4", "VGAM", "knitr")
for (pac in requiredPackages) {
  if(!require(pac,  character.only=TRUE)){
    install.packages(pac, repos="http://cran.rstudio.com")
    library(pac,  character.only=TRUE)
  } 
}
rm(pac)
rm(requiredPackages)

# Set WD and load data
wd = getwd()
if(grepl("nora", wd)) {
    setwd("~/git/csn-labs/02")
} else {
  setwd("~/Google Drive/UPC/Fall 2018/CSN/Labs/Lab2")
}
rm(wd)
```
```{r metric_functions, include=FALSE}

get_H <- function(k, gamma) {
  return(sum(seq(1, k)^(-gamma)))
}

get_AIC <- function(m2logL,K,N) {
  m2logL + 2*K*N/(N-K-1) # AIC with a correction for sample size
}

get_MP <- function(x) { return(sum(log(x)))}

get_C <- function(x) { C = 0
  for(i in x){
    j = 2
    while( j <= i){
      C <- C + log(j)
      j = j+1
    }
  } 
  return(C)
}
```

```{r comp_functions, include=FALSE}


############# Creating summary table

write_summary <- function(language,file) {
    degree_sequence = read.table(file, header = FALSE)
    l <- list(language,length(degree_sequence$V1),sum(degree_sequence$V1),max(degree_sequence$V1),sum(degree_sequence$V1)/length(degree_sequence$V1),length(degree_sequence$V1)/sum(degree_sequence$V1), get_MP(degree_sequence$V1), get_C(degree_sequence$V1))
    return(l)
}


create_sum_table <- function(source){
    
    temp_df <- data.table("Language" = character(),
                          "N" = numeric(),
                          "M" = numeric(),
                          "Maximum Degree" = numeric(),
                          "M/N" = numeric(),
                          "N/M" = numeric(),
                          "MP" = numeric(),
                          "C" = numeric(),
                          stringsAsFactors = FALSE)
    
    for (x in 1:nrow(source)){
        file <- source$file[x]
        language <- source$language[x]
        sequence <- write_summary(language, file)
        temp_df <- rbind(temp_df,sequence)
    }
    return(temp_df)
}               


###########  Estimating log-likelihood parameters ########### 
compute_log_likelihoods <- function(M, N, maxDegree, MP, C){

    # Displaced Poisson function
    minus_log_likelihood_poisson <- function(lambda){
      -(M * log(lambda) - N*(lambda + log(1 - exp(-lambda))) - C) 
    }
    
    # Displaced Geometric function
    minus_log_likelihood_geometric <- function(q){
      -(M - N) * log(1 - q) - N * log(q)
    }
    
    # Minus log-likelihood function (minus_log_likelihood = -L)
    minus_log_likelihood_zeta <- function(gamma){ 
      gamma * MP + N * log(zeta(gamma))
    }
    
    # Minus log-likelihood zeta function with lambda - 2
    minus_log_likelihood_zeta2 <- function(){
      2 * MP + N * log(pi^2/6)
    }
    
    # Minus log-likelihood right-truncated zeta
    minus_log_likelihood_zeta3 <- function(gamma){
      gamma * MP + N * log(get_H(maxDegree, gamma))
    }
    
    # Altmann function
    minus_log_likelihood_altmann <- function(lambda, delta){
      c * maxDegree^(-lambda) * e^(-delta * maxDegree)
    }
    
    mle_poisson <- mle(minus_log_likelihood_poisson,
                    start = list(lambda = M/N),
                    method = "L-BFGS-B",
                    lower = c(1.000001))

    mle_geometric <- mle(minus_log_likelihood_geometric,
                    start = list(q = N/M), 
                    method = "L-BFGS-B",
                    lower = c(0.01), 
                    upper = c(.99)) # No higher than .99 (ex: .999)

    mle_zeta <- mle(minus_log_likelihood_zeta,
                    start = list(gamma = 2),
                    method = "L-BFGS-B",
                    lower = c(1.00000001))

    mle_zeta2 <- mle(minus_log_likelihood_zeta,
                    fixed = list(gamma = 2),
                    method = "L-BFGS-B",
                    lower = c(1.00000001))

    # TODO: Check warning below. Doesn't look good.
    # Update 6/10: Check there is still warnings. Was using length(x) instead of N (wrong)
    mle_zeta3 <- mle(minus_log_likelihood_zeta3,
                    start = list(gamma = 2), #Alternatively, k = N
                    method = "L-BFGS-B",
                    lower = c(1.001, N))

    
    vec <- c(
        attributes(summary(mle_poisson))$coef[1],
        attributes(summary(mle_geometric))$coef[1],
        attributes(summary(mle_zeta))$coef[1],
        2,
        attributes(summary(mle_zeta3))$coef[1],
        get_AIC(attributes(summary(mle_poisson))$m2logL, 1, N),
        get_AIC(attributes(summary(mle_geometric))$m2logL, 1, N),
        get_AIC(attributes(summary(mle_zeta))$m2logL, 1, N),
        get_AIC(attributes(summary(mle_zeta2))$m2logL, 1, N),
        get_AIC(attributes(summary(mle_zeta3))$m2logL, 1, N)
    )

    return(vec)
}



########### MODEL SELECTION ########### 
compute_coeffs_table <- function(summary_table) {
    coeff_table <- data.table(#"language" = character(),
                          "lambda" = numeric(),
                          "q" = numeric(),
                          "gamma_1" = numeric(),
                          "gamma_2" = numeric(),
                          "k_max" = numeric(),
                          stringsAsFactors = FALSE)
    
    aic_table <- data.table(#"language" = character(),
                          "1" = numeric(),
                          "2" = numeric(),
                          "3" = numeric(),
                          "4" = numeric(),
                          "5" = numeric(),
                          stringsAsFactors = FALSE)
    
    for (i in seq(length(summary_table$Language))) {
        language <- summary_table[i]$Language 
        M <- summary_table[i]$M
        N <- summary_table[i]$N
        MP <- summary_table[i]$MP
        C <- summary_table[i]$C
        maxDegree <- summary_table[i]$`Maximum Degree`
        resultList <- compute_log_likelihoods(M, N, maxDegree, MP, C)
        g <- as.list(resultList[1:5])
        h <- as.list(resultList[6:10])
        coeff_table <- rbind(coeff_table, g)
        aic_table <- rbind(aic_table, h)
    }
    
    # Computing delta: AIC - best AIC 
    for (i in seq(length(aic_table$'1'))) {
        aic_table[i] <- aic_table[i] - min(aic_table[i])
    }
    return(list(coeff_table, aic_table))
}

```

# Introduction
The aim of this lab project is to analyze a degree distribution and select a theoretic model that best fits it. There are three sequences of which we can work on:

1. Undirected degree sequence.
2. In-degree sequence.
3. Out-degree sequence.

In our case, we have chosen to work with the out-degree one  for 10 different languages.

The first step on the analysis is to compute different metrics for each language, such as the length of the sequence (N) and the maximum degree, among others.

Additionally, to make our computations easier we have added a couple of metrics that we were not required in Table 1, which are M' and C.

```{r include=FALSE, echo=FALSE}

out_source = read.table("list_out.txt", header = TRUE, as.is = c("language","file")) 
(summary_table <- create_sum_table(out_source))

```


The resulting table is the following:

```{r echo=FALSE}
kable(summary_table)
```


# Results
Having computed the basic metrics, we now proceed onto compute the most likely parameters for the different given distributions.


```{r comp_tables, include=FALSE, echo=FALSE}
aic_c_table <- compute_coeffs_table(summary_table)
coeffs_table <- aic_c_table[1]
aic_table <- aic_c_table[2]
```

```{r echo=FALSE}
# kable(coeffs_table)
# TODO: Take coeffs table as a table or dataframe to column bind the languages
```


# Discussion

# Methods